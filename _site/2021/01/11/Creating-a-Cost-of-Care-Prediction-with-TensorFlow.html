<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
  <link href="https://unpkg.com/@videojs/themes@1/dist/sea/index.css" rel="stylesheet"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Creating a Cost of Care prediction with TensorFlow | 5 Minute Cloud</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Creating a Cost of Care prediction with TensorFlow" />
<meta name="author" content="Pete Wood" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I speak to a lot of people about AI. About the possibilities for healthcare, the limitations, the tools, and how the Cloud providers help us quickly build models. The conversation usually goes something like this. Hey, I’ve got a cool idea, we should use AI to look for INSERT FUNKY CLINICAL INSIGHT. Great idea, have you got some data we can use to create a model? Sure! I know at guy at INSERT FUNKY BUSINESS with some data we can borrow. What format is the data in? Is it AI-ready? Eh, what? I’m sure we can just build a model with it. There’s that word again. Just. The single word that glosses over reality, and simplifies the World. Just. I decided to explore what it takes to build, train and publish a simple AI model from some fairly raw data. In this 5 minute video, I explore how to create a simple ‘cost of care’ prediction model and gain experience with TensorFlow, Google’s open source software library for machine learning with particular focus on training of deep neural networks. I decided to explore the steps that it takes to go from zero to a fully trained published model. In this 5 minute video I’ll show you the steps I had to take to create a blueprint for further investigation." />
<meta property="og:description" content="I speak to a lot of people about AI. About the possibilities for healthcare, the limitations, the tools, and how the Cloud providers help us quickly build models. The conversation usually goes something like this. Hey, I’ve got a cool idea, we should use AI to look for INSERT FUNKY CLINICAL INSIGHT. Great idea, have you got some data we can use to create a model? Sure! I know at guy at INSERT FUNKY BUSINESS with some data we can borrow. What format is the data in? Is it AI-ready? Eh, what? I’m sure we can just build a model with it. There’s that word again. Just. The single word that glosses over reality, and simplifies the World. Just. I decided to explore what it takes to build, train and publish a simple AI model from some fairly raw data. In this 5 minute video, I explore how to create a simple ‘cost of care’ prediction model and gain experience with TensorFlow, Google’s open source software library for machine learning with particular focus on training of deep neural networks. I decided to explore the steps that it takes to go from zero to a fully trained published model. In this 5 minute video I’ll show you the steps I had to take to create a blueprint for further investigation." />
<link rel="canonical" href="http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html" />
<meta property="og:url" content="http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html" />
<meta property="og:site_name" content="5 Minute Cloud" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-11T00:00:00+00:00" />
<script type="application/ld+json">
{"dateModified":"2021-01-11T00:00:00+00:00","url":"http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html"},"author":{"@type":"Person","name":"Pete Wood"},"description":"I speak to a lot of people about AI. About the possibilities for healthcare, the limitations, the tools, and how the Cloud providers help us quickly build models. The conversation usually goes something like this. Hey, I’ve got a cool idea, we should use AI to look for INSERT FUNKY CLINICAL INSIGHT. Great idea, have you got some data we can use to create a model? Sure! I know at guy at INSERT FUNKY BUSINESS with some data we can borrow. What format is the data in? Is it AI-ready? Eh, what? I’m sure we can just build a model with it. There’s that word again. Just. The single word that glosses over reality, and simplifies the World. Just. I decided to explore what it takes to build, train and publish a simple AI model from some fairly raw data. In this 5 minute video, I explore how to create a simple ‘cost of care’ prediction model and gain experience with TensorFlow, Google’s open source software library for machine learning with particular focus on training of deep neural networks. I decided to explore the steps that it takes to go from zero to a fully trained published model. In this 5 minute video I’ll show you the steps I had to take to create a blueprint for further investigation.","headline":"Creating a Cost of Care prediction with TensorFlow","@type":"BlogPosting","datePublished":"2021-01-11T00:00:00+00:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  
    <link rel="stylesheet" href="/assets/css/post_style.css"><!-- THIS IS A COMMENT--><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="5 Minute Cloud" />

<link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico" ></head>
<body><header class="site-header">
 <DIV class='banner' id="myHeader">
   <a class="bannerlink"  href="/"></a>
 </div> 

 <!--
 <script> 
window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
    document.getElementById("myHeader").style.height = "100px";
    document.getElementById("myHeader").style.backgroundSize = "400px 133px";
  } else {
    document.getElementById("myHeader").style.height = "200px";
    document.getElementById("myHeader").style.backgroundSize = "600px 200px";
  }
}

</script>
-->

 
  <div class="wrapper"><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <a class="page-link" href="/">Home</a><a class="page-link" href="/disclaimer/">Disclaimer</a></div>
      </nav></div>

</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Creating a Cost of Care prediction with TensorFlow</h1>
    <p class="post-meta">
      By Pete Wood |<time class="dt-published" datetime="2021-01-11T00:00:00+00:00" itemprop="datePublished">
        Jan 11, 2021
      </time></p>
  </header>

  

<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=Five%20Minute%20Cloud&url=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>




  <div id="mycontent" class="post-content e-content" itemprop="articleBody">
    <p>I speak to a lot of people about AI. About the possibilities for healthcare, the limitations, the tools, and how the Cloud providers help us quickly build models. The conversation usually goes something like this.</p>

<p><em>Hey,  I’ve got a cool idea, we should use AI to look for INSERT FUNKY CLINICAL INSIGHT.</em></p>

<p><em>Great idea, have you got some data we can use to create a model?</em></p>

<p><em>Sure! I know at guy at INSERT FUNKY BUSINESS with some data we can borrow.</em></p>

<p><em>What format is the data in? Is it AI-ready?</em></p>

<p><em>Eh, what? I’m sure we can just build a model with it.</em></p>

<p>There’s that word again.  Just.  The single word that glosses over reality, and simplifies the World. Just. I decided to explore what it takes to build, train and publish a simple AI model from some fairly raw data. In this 5 minute video, I explore how to create a simple ‘cost of care’ prediction model and gain experience with <a href="https://to.fiveminute.cloud/1r2xMz">TensorFlow</a>, Google’s open source software library for machine learning with particular focus on training of deep neural networks. I decided to explore the steps that it takes to go from zero to a fully trained published model. In this 5 minute video I’ll show you the steps I had to take to create a blueprint for further investigation.</p>

<!--more-->

<h2 id="ingredients">Ingredients</h2>
<ul>
  <li>Docker (I’m using version 3.0.3), but any recent version should be fine</li>
  <li>Jupyter Notebooks for Python coding</li>
  <li>Scikit-Learn for data normalization</li>
  <li>Matplotlib and Seaborn for visualisation</li>
  <li>TensorFlow for linear regression machine learning algorithm</li>
  <li>Flask for publishing the API.</li>
</ul>

<p>These libraries will all be installed into the Docker container, which will be your local development environment.  You can watch the video below to follow along with the steps.
<br /><br /></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/6Zinxztsy5c" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<p><br />
We will build our  model in four simple steps:</p>
<ul>
  <li>Step 1 - Build a TensorFlow sandpit environment</li>
  <li>Step 2 - Setup our Jupyter notebook</li>
  <li>Step 3 - Build and train our machine learning model using linear regression</li>
  <li>Step 4 - We will publish our prediction model through an API using Flask</li>
</ul>

<h2 id="requirements-and-using-the-code-from-github">Requirements and using the code from GitHub</h2>
<p>The only thing you’ll need installed is Docker, and code can be downloaded from <a href="https://to.fiveminute.cloud/ekxWeR">GitHub</a>. On GitHub you’ll see a number of helper commands to help things run smoothly.</p>

<ul>
  <li><em>build</em> contains the command to build the Docker container from the <a href="https://github.com/fiveminutecloud/fmctensorflow/blob/main/Dockerfile">Dockerfile</a>.</li>
  <li><em>run</em> contains the commands to run our container, and also display the logs.</li>
  <li><em>cleanup</em> will stop and delete the Docker container.</li>
  <li><em>logs</em> will show the log files of the running container.</li>
</ul>

<p>You can copy the contents of GitHub to your local machine by running the <a href="https://git-scm.com/downloads">git</a> command.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/fiveminutecloud/fmctensorflow.git
</code></pre></div></div>

<h2 id="step-1---create-the-sandpit-environment">Step 1 - Create the sandpit environment</h2>
<p>Now, there are a few ways you can get a sandpit environment.  You can use something like AWS SageMaker, Azure Machine Learning, or Google Colab, but for this example we’ll quickly make our own local environment. This helps us understand a little more about what’s going on, but is also means you can use data sets which you might not be comfortable sharing on the Cloud.</p>

<p>Our Dockerfile uses the standard python 3.7 base image from DockerHub, on which we layer Jupyter Notebooks, the TensorFlow machine learning libraries and the Flask libraries to publish our API.</p>

<p><strong>Dockerfile</strong></p>
<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> python:3.7-slim</span>
<span class="k">RUN </span>apt-get update
<span class="k">RUN </span>pip3 <span class="nb">install </span>scikit-learn<span class="o">==</span>0.23.2
<span class="k">RUN </span>pip3 <span class="nb">install </span><span class="nv">jupyterlab</span><span class="o">==</span>2.2.9
<span class="k">RUN </span>pip3 <span class="nb">install </span><span class="nv">matplotlib</span><span class="o">==</span>3.3.3
<span class="k">RUN </span>pip3 <span class="nb">install </span><span class="nv">seaborn</span><span class="o">==</span>0.11.0
<span class="k">RUN </span>pip3 <span class="nb">install </span><span class="nv">numpy</span><span class="o">==</span>1.18.5
<span class="k">RUN </span>pip3 <span class="nb">install </span><span class="nv">tensorflow</span><span class="o">==</span>2.3.1
<span class="k">RUN </span>pip3 <span class="nb">install </span><span class="nv">flask</span><span class="o">==</span>1.1.2
<span class="k">CMD</span><span class="s"> ["jupyter-lab", "--ip=0.0.0.0", "--allow-root", "--notebook-dir=/notebooks"]</span>
</code></pre></div></div>

<p>Build the Docker container using the command</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -t fmctensorflow .
</code></pre></div></div>
<h2 id="step-2---setup-our-jupyter-notebook">Step 2 - Setup our Jupyter Notebook</h2>
<p>Now you have a container image, you run it with the following command. This command creates an instance of the container, and opens two ports on the container. Port 8888 is opened so you can access Jupyter Notebooks through your web browser, and port 5000 is opened for the API which we’ll create shortly.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -v $(pwd)/notebooks:/notebooks --name fmctensorflow -p 8888:8888 -p 5000:5000 fmctensorflow:latest
docker logs -f fmctensorflow
</code></pre></div></div>
<p>Within the logs, you should see a line which looks something like the line below. It contains the access token for the running instance of Jupyter, so you need that. Simply copy the whole line into your browser, to access the Notebook. I recommend using the last link which starts http://127.0.0.1.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    To access the notebook, open this file in a browser:
        file:///root/.local/share/jupyter/runtime/nbserver-1-open.html
    Or copy and paste one of these URLs:
        http://046ef7394882:8888/?token=9e976aecfb63ee81434e0272b4e996c130833ee891c91434e0272b4eaea6304e976aea8
     or http://127.0.0.1:8888/?token=e976aecfb63ee81434e0272b4e996c130833ee891c91434e0272b4eaea6304e976aea8
</code></pre></div></div>
<p>Now in your web browser, you should see <em>Launcher</em>. Click the Python3 logo to create a new Notebook.  You can right-click the file created on the left to rename it. 
<br /><br />
<img src="../../../assets/myimages/2021-01-12-17-39-42.png" alt="" /></p>

<h2 id="step-3---build-and-train-our-model">Step 3 - Build and train our model</h2>
<p>You can view the actual Notebook <a href="https://github.com/fiveminutecloud/fmctensorflow/blob/main/notebooks/fmctensorflow.ipynb">here</a>, but I’m going to summarize the eleven key steps below.</p>

<h3 id="a-import-the-libraries">a. Import the libraries</h3>
<p>Here we import the libraries that were layered into the Docker container during step 1. You’ll notice we’re using some libraries which we didn’t explicitly include (eg. Pandas), but we can still use them because they are part of the base Python 3.7 container.</p>

<h3 id="b-retrieve-the-data-set-for-training">b. Retrieve the data set for training</h3>
<p>The dataset we use for training is a public dataset from <a href="https://www.kaggle.com/mirichoi0218/insurance/home">Kaggle</a> with a small sample of USA population medical insurance costs. It has 1338 records, with columns as follows:
<br /><br /></p>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>Description</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Age</td>
      <td>Patient age</td>
      <td>Numeric</td>
    </tr>
    <tr>
      <td>Sex</td>
      <td>Patient sex</td>
      <td>Text</td>
    </tr>
    <tr>
      <td>BMI</td>
      <td>Patient body-mass index</td>
      <td>Numeric</td>
    </tr>
    <tr>
      <td>Children</td>
      <td>Number of children</td>
      <td>Numeric</td>
    </tr>
    <tr>
      <td>Smoker</td>
      <td>Is the patient a smoker?</td>
      <td>Text</td>
    </tr>
    <tr>
      <td>Region</td>
      <td>Patient’s home region</td>
      <td>Text</td>
    </tr>
    <tr>
      <td>Charges</td>
      <td>Insurance costs</td>
      <td>Numeric</td>
    </tr>
  </tbody>
</table>

<h3 id="c-visualise-and-explore-the-data-with-matplotlib">c. Visualise and explore the data with Matplotlib</h3>
<p>We are interested to understand the relationship between age and insurance costs. The following chart shows the distribution. Here we can see at least three linear relationships, so in the next step we’d like to understand the features that influence the insurance costs.
<br /><br />
<img src="../../../assets/myimages/2021-01-13-13-20-06.png" alt="" /></p>

<h3 id="d-map-the-textual-values-to-numerical-values">d. Map the textual values to numerical values</h3>
<p>In order to understand the features that influence insurance costs, we need to delve deeper into the data. We’d like to look at creating a <em>correlation matrix</em> to show how the costs change, as the features change. For example, do insurance costs go up as BMI increases?  How do the costs vary by region? 
In order to do this analysis, we use a <em>Correlation</em> function, but it only works with numeric data.  Therefore, we create three mapping functions to map Sex, Smoker and Region to numeric values, so we configure the following mappings. 
<br /><br /></p>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>Text Values</th>
      <th>Numeric Values</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Sex</td>
      <td>male, female, undefined</td>
      <td>0, 1, -1</td>
    </tr>
    <tr>
      <td>Smoker</td>
      <td>no, yes, undefined</td>
      <td>0, 1, -1</td>
    </tr>
    <tr>
      <td>Region</td>
      <td>southwest,southeast,northwest,northeast, undefined</td>
      <td>1, 2, 3, 4, 0</td>
    </tr>
  </tbody>
</table>

<h3 id="e-look-at-the-correlation-between-data-items-with-pandas-and-seaborn">e. Look at the <em>correlation</em> between data items with Pandas and SeaBorn</h3>
<p>We use <em>Pandas</em> to first create the Correlation matrix, and then we use <em>SeaBorn</em> to visualise the matrix to see the hotspots. From the charts below, we see the factors influencing the insurance costs are smoker, and then age. 
<br /><br /></p>

<table>
  <tbody>
    <tr>
      <td><img src="../../../assets/myimages/2021-01-13-13-41-01.png" alt="" /></td>
      <td><img src="../../../assets/myimages/Sex.png" alt="" /></td>
    </tr>
  </tbody>
</table>

<h3 id="f-separate-the-smokers-from-the-nonsmokers">f. Separate the Smokers from the Nonsmokers</h3>
<p>Since Smokers is a ‘yes/no’ value, in the next step we split the source data into Smokers and Nonsmokers so we can see the different trends. In the image below we can see the split of smokers and nonsmokers. We can see at least 3 linear relationships. We can see two for smokers (in grey), and a good linear relationship for nonsmokers (in blue) but with a sizable set of anomalies. So, for the rest of this adventure we’ll focus on the nonsmokers only. 
<br /><br />
<img src="../../../assets/myimages/2021-01-13-13-48-36.png" alt="" /></p>

<h3 id="g-look-at-the-correlation-between-features-for-only-nonsmokers">g. Look at the correlation between features for only Nonsmokers</h3>
<p>Now, we re-run the Correlation function for nonsmokers only, and we discover that age (unsurprisingly!) becomes the most significant factor in insurance charges.
<br /><br />
<img src="../../../assets/myimages/2021-01-13-13-54-06.png" alt="" /></p>

<h3 id="h-normalize-the-input-values-with-scikit-learn">h. Normalize the input values with Scikit-Learn</h3>
<p>We now need to prepare the data for training.  It is best practice to normalize the input values, and we do this by creating a <em>scaler</em>.  The scaler is a function that condenses the input dataset (age) down to a unit range (between 0-1). If you don’t do this, you may find your modeling fit <a href="https://machinelearningmastery.com/exploding-gradients-in-neural-networks/"><em>explodes</em></a>. You don’t need to normalize the output values (costs).
<br /><br />
<img src="../../../assets/myimages/2021-01-13-13-56-33.png" alt="" /></p>

<h3 id="i-split-the-data-into-a-training-and-testing-dataset">i. Split the data into a training and testing dataset</h3>
<p>There is one last thing needed before training the model. In step 3b, I noted we have 1338 records in our data set, of which 1064 are nonsmokers. We want to use most of the data for training the model. But, we also want to hold back some data so we can test the model afterwards and compare the predicted result with the actual result already known.  This helps us understand the accuracy of our model. We decide to train the model on 1010 (95%) nonsmokers, and hold back 54 records for testing later.</p>

<h3 id="j-train-the-model-with-tensorflow">j. Train the model with TensorFlow</h3>
<p><em>Finally!</em> Eleven steps later, we can train our model with TensorFlow. TensorFlow works by creating <em>models</em> and <em>layers</em>. Models are made up of layers, and layers are the <em>functions</em> containing the mathematical function. The power of TensorFlow allows you to build complex networks with multiple layers leading to very sophisticated prediction models. We will only create one <a href="https://keras.io">Keras</a> layer.  The model fitting process is essentially <em>random</em>.  And if you run the fitting process multiple times, you’ll get different results, unless you set the <a href="https://machinelearningmastery.com/reproducible-results-neural-networks-keras/">seed</a> for the random number generator. Fitting basically selects a random position, and tests the training data against it.  It uses <em>Optimizers</em> to determine the accuracy (or ‘loss’) of the prediction against the known outcome in the training set and adjusts the random position accordingly.  It’s like guessing a number between 1 and 100. You guess 50, I say lower. You guess 25, I say higher. Eventually you guess correctly. Sometimes you get lucky and it only takes a few guesses, other times it takes longer.  Each guess is called an <em>Epoch</em>, and the more guesses you have the longer it takes, and the better the result. We’re using just 1000 epochs here. We’re only using 1064 records to train our model, and it works just fine locally. But what if you have millions, or billions of records. Well, TensorFlow scales crazy-well, and lots of the cloud providers, but especially <a href="https://towardsdatascience.com/multi-worker-distributed-tensorflow-training-on-google-cloud-ai-platform-64b383341dd8">Google Cloud AI</a> support TensorFlow at scale. All this work allows us to run just three commands to train our model.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'sgd'</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s">'mean_squared_error'</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>
<p>We wait a few minutes for the modelling to run, and what do we get for our trouble? We get an <em>in memory</em> model that we can use for predictions. But first, let’s evaluate our model against the 54 records we held back in step 3i. We need to check the model makes reasonable predictions.</p>

<h3 id="k-evaluate-the-model-with-the-remaining-data-set">k. Evaluate the model with the remaining data set</h3>
<p>In this step we evaluate the model against the 54 records we held back.  We already know the insurance costs for these patients, so let’s see what the new prediction model gives. The green-dots show the actual costs recorded in the source data, but the red-crosses show the predicted costs. And it’s not too bad! Clearly, the test data has some anomalies, but remember in step 3g we choose to only focus on the patients <em>age</em>.  We haven’t accounted for other features such as number of children, or BMI which may explain these deviations.</p>

<p>You may also notice that the <em>age</em> axis is still normalized because our model was trained on normalized <em>age</em> data. In the final step 4,  you’ll see how we publish the model as an API, and use the <em>Scaler</em> from step 3h to normalize the age for which we want the insurance cost prediction. 
<br /><br />
<img src="../../../assets/myimages/2021-01-13-15-53-41.png" alt="" /></p>

<h2 id="step-4---deploy-the-model-as-an-api-with-flask">Step 4 - Deploy the model as an API with Flask</h2>
<p>We use the in-memory model created above, and create a web API around it so it can be used by mobile and web apps. We use Flask to create the API infrastructure, with one simple GET endpoint <em>predict</em>, that takes <em>age</em> as a single input value. When the container was started above in step 2, we opened port 5000 so we can access the Flask API though our web browser. We can now access the insurance cost predictor through one simple endpoint.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:5000/predict?age=45
</code></pre></div></div>

<p>Remember, I said above the model works on a <em>normalized</em> age value, so we simply use the same scaler from step 3h we created before to scale the age.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     scaler_input_array = np.array([[age,0]]) 
     scaled_age = mm_scaler.transform(scaler_input_array)[0][0] 
     cost_prediction = model.predict([scaled_age])[0][0]  
</code></pre></div></div>

<p>We then pass the <em>normalized</em> age to the model predictor and return the insurance cost in the HTTP response.</p>

<p><br /><br />
<img src="../../../assets/myimages/2021-01-12-18-32-30.png" alt="" /></p>

<h2 id="if-you-run-into-problems">If you run into problems</h2>
<p>I like testing ideas in a isolated container because it provides a nice clean working space with known libraries. Also, if you run into difficulties, you can simply hit <em>reset</em> and start again from a known state. The container can be restarted by running the <em>cleanup</em> commands:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker kill fmctensorflow
docker rm fmctensorflow
</code></pre></div></div>
<p>You can then restart your container using the commands in step 2.</p>

<p>If you have any other difficulties, please comment below.</p>


  </div>

  

<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=Five%20Minute%20Cloud&url=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>


<div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html';
      this.page.identifier = 'http://localhost:4000/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://fiveminutecloud.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/2021/01/11/Creating-a-Cost-of-Care-Prediction-with-TensorFlow.html" hidden></a>
</article>

      </div>
    </main><!-- <footer class="site-footer h-card">

  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Pete Wood</li>
          <li><a class="u-email" href="mailto:pete@fiveminute.cloud">pete@fiveminute.cloud</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Healthcare Cloud Technology
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://twitter.com/fiveminutecloud" title="fiveminutecloud"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div> 
 

</footer> -->

<div class="myfooter">
 
  <a href="https://to.fiveminute.cloud/twitter"><span class='footertext'>Twitter</span></a>
  <span class='footertext'>&nbsp&nbsp|&nbsp&nbsp</span>  
  <a href="https://to.fiveminute.cloud/youtube"><span class='footertext'>YouTube</span></a> 
  <span class='footertext'>&nbsp&nbsp|&nbsp&nbsp</span>
  <a href="https://to.fiveminute.cloud/github"><span class='footertext'>GitHub</span></a> 
  <span class='footertext'>&nbsp&nbsp|&nbsp&nbsp</span>  
  <a href="/feed.xml"><span class='footertext'>RSS Feed</span></a> 
 
  
  <!--
    <p>
    <a href="/feed.xml">
      <svg class="svg-icon orange">
        <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
      </svg><span style="color:white; padding-right: 20px;">Subscribe</span>
    </a>
  </p>
-->
</div>
</body>

</html>
